AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Enqueue NFL player scraping tasks from Depth Charts (daily)

Globals:
  Function:
    Runtime: python3.12
    Timeout: 120
    MemorySize: 512
    Architectures:
      - x86_64
    Environment:
      Variables:
        SUPABASE_URL: !Ref SupabaseUrl
        SUPABASE_KEY: !Ref SupabaseKey
        PLAYER_QUEUE_URL: !Ref PlayerQueue

Parameters:
  SupabaseUrl:
    Type: String
    Description: Supabase project URL
  SupabaseKey:
    Type: String
    Description: Supabase service role key (or anon key if read-only)

Resources:

  ###########################################################
  #  SQS Queues
  ###########################################################

  PlayerDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: player-scrape-dlq
      MessageRetentionPeriod: 1209600  # 14 days

  PlayerQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: player-scrape-queue
      VisibilityTimeout: 120           # > Lambda timeout
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt PlayerDLQ.Arn
        maxReceiveCount: 3

  ###########################################################
  #  Lambda Function: Enqueue
  ###########################################################

  EnqueuePlayersFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambda_function.lambda_handler
      Description: Queries Supabase Depth Charts and enqueues players for scraping
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt PlayerQueue.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Name: enqueue-daily
            Description: Run enqueue lambda on Thu/Sat/Sun at 05:00 UTC
            Schedule: cron(0 5 ? * THU,SAT,SUN *)  # 05:00 UTC on Thu/Sat/Sun
            Enabled: true

Outputs:
  EnqueuePlayersFunction:
    Description: Enqueue Lambda function ARN
    Value: !GetAtt EnqueuePlayersFunction.Arn
  PlayerQueueUrl:
    Description: SQS Queue URL
    Value: !Ref PlayerQueue
  PlayerQueueArn:
    Description: SQS Queue ARN
    Value: !GetAtt PlayerQueue.Arn
